---
const title = "POI → GeoJSON Generator";
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{title}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 40px;
    }

    .container {
      max-width: 820px;
      margin: auto;
      background: #fff;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h1 {
      margin-top: 0;
      font-size: 28px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    label {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      display: block;
    }

    input, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .full {
      grid-column: span 2;
    }

    button {
      margin-top: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #6b7280;
      margin-left: 10px;
    }

    pre {
      margin-top: 24px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
      border-radius: 10px;
      overflow-x: auto;
      font-size: 13px;
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #10b981;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>{title}</h1>

    <div class="grid">
      <div>
        <label>Latitude</label>
        <input id="lat" type="number" step="any" placeholder="48.1979108" />
      </div>

      <div>
        <label>Longitude</label>
        <input id="lng" type="number" step="any" placeholder="16.3658069" />
      </div>

      <div class="full">
        <label>OR Google Maps Coordinates</label>
        <input id="gmaps" type="text" placeholder="48.1959801840249, 16.36017068166236" />
        <div class="hint">Paste coordinates directly from Google Maps (format: latitude, longitude)</div>
      </div>

      <div>
        <label>Name</label>
        <input id="name" type="text" placeholder="POI Name" />
      </div>

      <div>
        <label>Category</label>
        <input id="category" type="text" list="categories" placeholder="cafe, bar, museum..." />
        <datalist id="categories"></datalist>
        <div class="hint">Select from dropdown or type custom category</div>
      </div>

      <div class="full">
        <label>Description</label>
        <textarea id="description"></textarea>
      </div>

      <div class="full">
        <label>Link</label>
        <input id="link" type="url" placeholder="https://example.com" />
      </div>
    </div>

    <button id="generateBtn">Generate JSON</button>
    <button class="secondary" id="copyBtn">Copy</button>

    <pre id="output">{}</pre>
  </div>

  <div id="toast" class="toast">Copied to clipboard!</div>

  <!-- ✅ THIS is the critical fix -->
  <script is:inline>
    // Load categories from categories.json
    async function loadCategories() {
      try {
        const response = await fetch('/data/categories.json');
        const data = await response.json();
        const datalist = document.getElementById('categories');

        // Populate datalist with category options
        Object.entries(data.categories).forEach(([key, value]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${value.emoji} ${value.name}`;
          datalist.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load categories:', error);
      }
    }

    function parseGoogleMapsCoords(input) {
      // First try to parse as simple "lat, lng" format
      const simpleMatch = input.match(/^\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*$/);
      if (simpleMatch) {
        return {
          lat: parseFloat(simpleMatch[1]),
          lng: parseFloat(simpleMatch[2])
        };
      }

      // Fallback: try to parse as Google Maps URL with @lat,lng
      const urlMatch = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
      if (urlMatch) {
        return {
          lat: parseFloat(urlMatch[1]),
          lng: parseFloat(urlMatch[2])
        };
      }

      return null;
    }

    function generateJSON() {
      let lat = parseFloat(document.getElementById("lat").value);
      let lng = parseFloat(document.getElementById("lng").value);

      const gmaps = document.getElementById("gmaps").value.trim();

      if (gmaps) {
        const coords = parseGoogleMapsCoords(gmaps);
        if (!coords) {
          alert("Invalid coordinates format. Please use format: latitude, longitude (e.g., 48.1959801840249, 16.36017068166236)");
          return;
        }
        lat = coords.lat;
        lng = coords.lng;
      }

      if (isNaN(lat) || isNaN(lng)) {
        alert("Please enter valid coordinates.");
        return;
      }

      const feature = {
        type: "Feature",
        geometry: {
          type: "Point",
          coordinates: [lng, lat]
        },
        properties: {
          name: document.getElementById("name").value,
          category: document.getElementById("category").value,
          description: document.getElementById("description").value,
          link: document.getElementById("link").value
        }
      };

      document.getElementById("output").textContent =
        JSON.stringify(feature, null, 2);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");

      setTimeout(() => {
        toast.classList.remove("show");
      }, 2000);
    }

    function copyJSON() {
      const output = document.getElementById("output").textContent;
      if (!output || output === "{}") {
        alert("Generate JSON first.");
        return;
      }

      navigator.clipboard.writeText(output);
      showToast("Copied to clipboard!");
    }

    // ✅ Proper event binding (Astro-safe)
    document.getElementById("generateBtn").addEventListener("click", generateJSON);
    document.getElementById("copyBtn").addEventListener("click", copyJSON);

    // Load categories on page load
    loadCategories();
  </script>

</body>
</html>
